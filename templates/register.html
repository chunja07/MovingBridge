{% extends "base.html" %}

{% block title %}회원가입 - 1단계 - 무빙브릿지{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-success text-white text-center">
                    <h3 class="mb-0">외국인 구직자 등록 - 1단계</h3>
                    <small>기본 정보를 입력해주세요</small>
                </div>
                <div class="card-body">
                    <div class="progress mb-4">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 50%">
                            1단계 / 2단계
                        </div>
                    </div>
                    
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.name.label(class="form-label") }}
                                {{ form.name(class="form-control") }}
                                {% for error in form.name.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.username.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.username(class="form-control", id="username_field") }}
                                    <button type="button" class="btn btn-outline-primary" id="check_username_btn">중복확인</button>
                                </div>
                                <div id="username_check_result" class="small mt-1"></div>
                                {% for error in form.username.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                {{ form.email.label(class="form-label") }}
                                {{ form.email(class="form-control", type="email") }}
                                {% for error in form.email.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.password.label(class="form-label") }}
                                {{ form.password(class="form-control") }}
                                {% for error in form.password.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.confirm_password.label(class="form-label") }}
                                {{ form.confirm_password(class="form-control") }}
                                {% for error in form.confirm_password.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="row">
                            
                            <div class="col-md-6 mb-3">
                                {{ form.nationality.label(class="form-label") }}
                                {{ form.nationality(class="form-select") }}
                                {% for error in form.nationality.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.gender.label(class="form-label") }}
                                {{ form.gender(class="form-select") }}
                                {% for error in form.gender.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.korean_fluent.label(class="form-label") }}
                                {{ form.korean_fluent(class="form-select") }}
                                {% for error in form.korean_fluent.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.languages.label(class="form-label") }}
                            <div class="row">
                                {% for subfield in form.languages %}
                                <div class="col-md-4 col-sm-6 mb-2">
                                    <div class="form-check">
                                        {{ subfield(class="form-check-input") }}
                                        {{ subfield.label(class="form-check-label") }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="form-text">구사 가능한 언어를 모두 선택해주세요</div>
                            {% for error in form.languages.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.preferred_jobs.label(class="form-label") }}
                                {{ form.preferred_jobs(class="form-select") }}
                                {% for error in form.preferred_jobs.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.preferred_location.label(class="form-label") }}
                                {{ form.preferred_location(class="form-select") }}
                                {% for error in form.preferred_location.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.availability.label(class="form-label") }}
                            {{ form.availability(class="form-select") }}
                            {% for error in form.availability.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="mb-3">
                            {{ form.self_intro.label(class="form-label") }}
                            {{ form.self_intro(class="form-control", rows="4", placeholder="자신을 소개해주세요...") }}
                            {% for error in form.self_intro.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <div class="mb-3">
                            {{ form.video_link.label(class="form-label") }}
                            {{ form.video_link(class="form-control", placeholder="https://youtube.com/watch?v=...") }}
                            <div class="form-text">선택사항: 자기소개 영상 링크를 입력해주세요</div>
                            {% for error in form.video_link.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <!-- 개인정보 동의 섹션 -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">개인정보 수집 및 이용 동의</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-3">구직 서비스에 가입하시려면, 아래의 개인정보 수집 및 이용에 대한 동의를 부탁드립니다.</p>
                                
                                <div class="privacy-text mb-3" style="max-height: 180px; overflow-y: auto; font-size: 0.9em; background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6;">
                                    <p><strong>수집하는 개인정보 항목:</strong> 이름, 연락처, 경력 사항 등</p>
                                    
                                    <p><strong>개인정보의 이용 목적:</strong> 구인 기업과의 매칭, 직무 추천, 서비스 제공 및 개선을 위한 분석</p>
                                    
                                    <p><strong>개인정보 보유 및 이용 기간:</strong> 서비스 종료 후 3년간 보유</p>
                                    
                                    <p><strong>동의를 거부할 권리:</strong> 개인정보 수집에 대한 동의를 거부할 권리가 있으며, 거부 시 일부 서비스 이용이 제한될 수 있습니다.</p>
                                    
                                    <p class="mb-0 text-muted">"동의함"을 클릭하시면 개인정보 수집 및 이용에 동의한 것으로 간주됩니다.</p>
                                </div>
                                
                                <div class="form-check mb-2">
                                    {{ form.privacy_agreement(class="form-check-input") }}
                                    {{ form.privacy_agreement.label(class="form-check-label") }}
                                    {% for error in form.privacy_agreement.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                                
                                <div class="form-check">
                                    {{ form.terms_agreement(class="form-check-input") }}
                                    {{ form.terms_agreement.label(class="form-check-label") }}
                                    {% for error in form.terms_agreement.errors %}
                                        <div class="text-danger small">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            {{ form.submit(class="btn btn-success btn-lg") }}
                        </div>
                    </form>
                    
                    <div class="text-center mt-3">
                        <p class="text-muted">
                            업체로 가입하시겠습니까? 
                            <a href="{{ url_for('register_company') }}" class="text-decoration-none">업체 가입</a> | 
                            <a href="{{ url_for('register_choice') }}" class="text-decoration-none">가입 유형 선택</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkUsernameBtn = document.getElementById('check_username_btn');
    const usernameField = document.getElementById('username_field');
    const resultDiv = document.getElementById('username_check_result');
    
    checkUsernameBtn.addEventListener('click', function() {
        const username = usernameField.value.trim();
        
        if (!username) {
            resultDiv.innerHTML = '<span class="text-warning">사용자명을 입력해주세요.</span>';
            return;
        }
        
        if (username.length < 3) {
            resultDiv.innerHTML = '<span class="text-warning">사용자명은 3자 이상이어야 합니다.</span>';
            return;
        }
        
        // 버튼 비활성화 및 로딩 표시
        checkUsernameBtn.disabled = true;
        checkUsernameBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 확인중...';
        resultDiv.innerHTML = '';
        
        // AJAX 요청
        fetch('/check_username', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username: username })
        })
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                resultDiv.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> ' + data.message + '</span>';
            } else {
                resultDiv.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle"></i> ' + data.message + '</span>';
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<span class="text-danger">확인 중 오류가 발생했습니다.</span>';
        })
        .finally(() => {
            // 버튼 원상복구
            checkUsernameBtn.disabled = false;
            checkUsernameBtn.innerHTML = '중복확인';
        });
    });
    
    // 사용자명이 변경되면 결과 초기화
    usernameField.addEventListener('input', function() {
        resultDiv.innerHTML = '';
    });
});
</script>

{% endblock %}